<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <style>
            #answer {
                font-size: 25px;
            }
        </style>
    </head>
    <body>
        <p id="answer"></p>

        <script type="module">
            import FileReader from '../../FileReader.js';
            import Parser from './Parser.js';

            const fileReader = new FileReader('./data.txt', new Parser());
            const {wireIds, instructions} = await fileReader.parse();
            const wires = {};

            // Create wire objects from the wire IDs
            wireIds.forEach(wireId => wires[wireId] = {
                wireId,
                signal: undefined,
            });

            // Resolve an operand for an operation
            const getOperandValue = operand => {
                if (/^\d+$/.test(operand) === true) {
                    return parseInt(operand, 10);
                }

                const wire = wires[operand];

                // If the wire doesn't have a signal yet, resolve the instruction that sets it
                if (wire.signal === undefined) {
                    const instruction = instructions.find(instruction => instruction.wireId === operand);
                    instruction.resolve();
                    instruction.isResolved = true;
                }

                return wire.signal;
            };

            // Place wire objects in the instructions
            // and convert operations to callbacks
            instructions.forEach(instruction => {
                instruction.wire = wires[instruction.wireId];

                // The operation is a normal assignment
                if (instruction.operation.length === 1) {
                    instruction.resolve = () => instruction.wire.signal = getOperandValue(instruction.operation);
                }

                // The operation is NOT
                else if (instruction.operation.length === 2) {
                    instruction.resolve = () => {
                        const otherSignal = getOperandValue(instruction.operation[1]);

                        // Convert the result to unsigned 16 bit
                        instruction.wire.signal = (~otherSignal >>> 0) % (2 ** 16);
                    };
                }
                
                // The operation is AND, OR, LSHIFT or RSHIFT
                else {
                    switch (instruction.operation[1]) {
                        case 'AND':
                            instruction.resolve = () => instruction.wire.signal =
                                getOperandValue(instruction.operation[0])
                                & getOperandValue(instruction.operation[2]);
                            break;
                        case 'OR':
                            instruction.resolve = () => instruction.wire.signal =
                                getOperandValue(instruction.operation[0])
                                | getOperandValue(instruction.operation[2]);
                            break;
                        case 'LSHIFT':
                            instruction.resolve = () => instruction.wire.signal =
                                getOperandValue(instruction.operation[0])
                                << getOperandValue(instruction.operation[2]);
                            break;
                        case 'RSHIFT':
                            instruction.resolve = () => instruction.wire.signal =
                                getOperandValue(instruction.operation[0])
                                >> getOperandValue(instruction.operation[2]);
                            break;
                    }
                }
            });

            instructions.forEach((instruction, index) => {
                // Skip already resolved instructions
                if (instruction.isResolved === true) {
                    return;
                }

                instruction.resolve();
                instruction.isResolved = true;
            });

            answer.innerText = wires['a'].signal;
        </script>
    </body>
</html>
