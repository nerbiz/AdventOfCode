<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <style>
            #answer {
                font-size: 25px;
            }
        </style>
    </head>
    <body>
        <p id="answer"></p>

        <script type="module">
            import FileReader from '../FileReader.js';
            import Parser from './Parser.js';
            import Utilities from '../Utilities.js';

            const fileReader = new FileReader('./datatest.txt', new Parser());
            const riskMap = await fileReader.parse();

            const showRoute = () => {
                // Replace value of unused points with a space
                let valueMap = Utilities.map2D(riskMap, (point, x, y) => (point.use) ? point.value.toString() : ' ');
                // valueMap = valueMap.map(row => row.join(''))
                console.log(valueMap);
            }

            const fromPoint = point => {
                // The point is used in the path
                point.use = true;

                // Find the points to the right and below the current
                const pointRight = (riskMap[point.y][point.x + 1] !== undefined)
                    ? riskMap[point.y][point.x + 1]
                    : null;
                const pointDown = (riskMap[point.y + 1] !== undefined)
                    ? riskMap[point.y + 1][point.x]
                    : null;

                // Endpoint (bottom right) reached
                if (pointRight === null && pointDown === null) {
                    return;
                }
                // Can't move right anymore
                else if (pointRight === null) {
                    return fromPoint(pointDown);
                }
                // Can't move down anymore
                else if (pointDown === null) {
                    return fromPoint(pointRight);
                }

                // Imagine a diagonal line towards bottom-right
                // Average numbers above and below that line
                let startX = point.x;
                let endX = point.x;
                const aboveDiagonal = riskMap.map(row => row.slice(++startX));
                const belowDiagonal = riskMap.slice(point.y + 1).map(row => row.slice(point.x, ++endX));
                const aboveDiagonalAverage = aboveDiagonal
                    .reduce((sum, point) => (sum + point.value), 0)
                    / aboveDiagonal.length;
                const belowDiagonalAverage = belowDiagonal
                    .reduce((sum, point) => (sum + point.value), 0)
                    / aboveDiagonal.length;

                // Move in the direction of the lowest average
                (aboveDiagonalAverage > belowDiagonalAverage)
                    ? fromPoint(pointRight)
                    : fromPoint(pointDown);
            };

            fromPoint(riskMap[0][0]);

            showRoute();
        </script>
    </body>
</html>
