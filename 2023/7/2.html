<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Advent of Code</title>
        <link rel="stylesheet" href="../../style.css">
    </head>
    <body>
        <p class="answer"></p>

        <script type="module">
            import FileReader from '../../classes/FileReader.js';
            import Parser from './Parser.js';

            const fileReader = new FileReader('./data.txt', new Parser());
            let rounds = await fileReader.parse();
            console.time('Time elapsed');

            // Mapping of face cards and their values (number cards are its own value)
            const cardValues = { 'J': 1, 'T': 10, 'Q': 11, 'K': 12, 'A': 13 };

            // In order: high card, one pair, two pair, three of a kind, full house, four of a kind, five of a kind
            // These represent occurrences of each card
            const typeScores = ['11111', '2111', '221', '311', '32', '41', '5'];

            // The mapping of how jokers can make a stronger type,
            // for different amounts of jokers
            const jokerIncreases = {
                '11111': {1: '2111'},
                '2111': {1: '311', 2: '311'},
                '221': {1: '32', 2: '41'},
                '311': {1: '41', 3: '41'},
                '32': {2: '5', 3: '5'},
                '41': {1: '5', 4: '5'},
                '5': {5: '5'},
            };

            document.querySelector('.answer').innerText = rounds
                .map(([cards, bid]) => {
                    // Convert face cards to numeric values and accumulate occurrences and jokers
                    let occurrences = [];
                    let jokerCount = 0;
                    cards = cards.map(card => {
                        const value = cardValues[card] ?? card - 0;
                        occurrences[value] ||= 0;
                        occurrences[value]++;
                        jokerCount += Number(card === 'J');

                        return value;
                    });

                    // Get the score for the type, maybe increased by jokers
                    occurrences = occurrences.sort((a, b) => b - a).join('');
                    if (jokerCount > 0) {
                        occurrences = jokerIncreases[occurrences][jokerCount];
                    }
                    const score = typeScores.indexOf(occurrences);

                    return { cards, bid, score };
                })
                .sort((a, b) => {
                    // Sort by score if they're different
                    if (a.score !== b.score) {
                        return a.score - b.score;
                    }

                    // Otherwise sort by the first card that is different
                    for (let i = 0; i < a.cards.length; i++) {
                        if (a.cards[i] === b.cards[i]) {
                            continue;
                        }

                        return a.cards[i] - b.cards[i];
                    }
                })
                .reduce((winnings, round, index) => winnings + ((index + 1) * round.bid), 0);

            console.timeEnd('Time elapsed');
        </script>
    </body>
</html>
