<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Advent of Code</title>
        <style>
            #answer {
                font-size: 25px;
            }
        </style>
    </head>
    <body>
        <p id="answer"></p>

        <script type="module">
            import FileReader from '../../FileReader.js';
            import Parser from './Parser.js';
            import ArrayPrototype from '../../ArrayPrototype.js';
            import PriorityQueue from '../../PriorityQueue.js';

            ArrayPrototype.extend();
            const fileReader = new FileReader('./data.txt', new Parser());
            const instructions = await fileReader.parse();
            const availableSteps = new PriorityQueue();
            let order = '';

            // Create a list of steps, with their required step(s)
            let steps = {};
            for (const instruction of instructions) {
                if (! (instruction.step in steps)) {
                    steps[instruction.step] = [];
                }

                steps[instruction.step].push(instruction.required);
            }

            steps = Object.entries(steps);
            const allRequiredSteps = steps.map(step => step[1]).flat().unique();
            const stepsWithRequirements = steps.map(step => step[0]);

            // The first available steps are the ones that don't have required steps
            const firstSteps = allRequiredSteps.difference(stepsWithRequirements);
            for (const firstStep of firstSteps) {
                availableSteps.enqueue(firstStep.charCodeAt(0), firstStep);
            }

            while (! availableSteps.isEmpty()) {
                const step = availableSteps.dequeue();
                order += step;

                steps = steps
                    // Remove the current step from the required steps of other steps
                    .map(otherStep => [
                        otherStep[0],
                        otherStep[1].filter(required => required !== step),
                    ])
                    // Take available steps out of the current list
                    .filter(step => {
                        if (step[1].length > 0) {
                            return true;
                        }

                        availableSteps.enqueue(step[0].charCodeAt(0), step[0]);
                    });
            }

            document.querySelector('#answer').innerText = order;
        </script>
    </body>
</html>
