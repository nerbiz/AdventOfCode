<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <style>
            #answer {
                font-size: 25px;
            }
        </style>
    </head>
    <body>
        <p id="answer"></p>

        <script type="module">
            import FileReader from '../../FileReader.js';
            import Parser from './Parser.js';

            const fileReader = new FileReader('./data.txt', new Parser());
            const events = await fileReader.parse();
            const midnightHour = Array(60)
                .fill(undefined)
                .map((minute, index) => ({minute: index}));
            const guardIds = [];

            // Sort the events by date (ascending)
            events.sort((a, b) => a.date - b.date);

            let guardId;
            let asleepMinute;
            for (const event of events) {
                // Convert any dates before midnight, to midnight
                if (event.date.getHours() === 23) {
                    event.date.setHours(0);
                    event.date.setMinutes(0);
                }

                // Set the guard ID for the following events
                if (event.guardId !== undefined) {
                    guardId = event.guardId;

                    if (! guardIds.includes(guardId)) {
                        guardIds.push(guardId);
                    }
                }

                // The guard falls asleep
                if (event.status === 'asleep') {
                    asleepMinute = event.date.getMinutes();
                }

                // The guard wakes up
                else {
                    // Increase the asleep count of the guard, for the preceding minutes
                    if (asleepMinute !== undefined) {
                        for (let minute = asleepMinute; minute < event.date.getMinutes(); minute++) {
                            midnightHour[minute][guardId] = (midnightHour[minute][guardId] || 0);
                            midnightHour[minute][guardId]++;
                        }
                    }
                }
            }

            // Find the guard that sleeps the most
            const mostSleepyGuardId = guardIds
                .map(guardId => ({
                    guardId,
                    asleepAmount: midnightHour.reduce((sum, minute) => sum + (minute[guardId] || 0), 0),
                }))
                .sort((a, b) => b.asleepAmount - a.asleepAmount)
                .at(0)
                .guardId;

            // Find the minute at which the guard sleeps the most often
            const mostAsleepMinute = midnightHour
                .sort((a, b) => b[mostSleepyGuardId] - a[mostSleepyGuardId])
                .filter(minute => minute[mostSleepyGuardId] !== undefined)
                .at(0)
                .minute;

            document.querySelector('#answer').innerText = mostSleepyGuardId * mostAsleepMinute;
        </script>
    </body>
</html>
